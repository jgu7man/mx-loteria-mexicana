<div class="manager-container min-h-screen bg-gradient-to-br from-indigo-600 to-purple-700 p-8">
  <!-- Header -->
  <header class="flex justify-between items-center mb-8">
    <h1 class="text-4xl font-bold text-white">üë®‚Äçüíº Manager Dashboard</h1>
    <button 
      (click)="goHome()"
      class="bg-white text-purple-600 px-6 py-2 rounded-lg font-semibold hover:bg-gray-100 transition">
      ‚Üê Volver
    </button>
  </header>

  <!-- Not authenticated -->
  <div *ngIf="!isAuthenticated()" class="text-center">
    <div class="bg-white rounded-2xl shadow-2xl p-12 max-w-md mx-auto">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Inicia sesi√≥n para crear salas</h2>
      <button 
        (click)="signInWithGoogle()"
        class="bg-blue-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-600 transition">
        üîê Iniciar sesi√≥n con Google
      </button>
    </div>
  </div>

  <!-- Authenticated - No room -->
  <div *ngIf="isAuthenticated() && !room()" class="text-center">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-4xl mx-auto">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Bienvenido, {{ currentUser()?.displayName }}!</h2>
      
      <!-- Salas creadas -->
      <div *ngIf="managerRooms().length > 0" class="mb-8">
        <h3 class="text-xl font-bold text-gray-700 mb-4 text-left">Tus Salas</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button
            *ngFor="let managerRoom of managerRooms()"
            (click)="selectRoom(managerRoom)"
            class="p-4 border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:shadow-lg transition text-left">
            <div class="flex justify-between items-start mb-2">
              <h4 class="text-lg font-bold text-gray-800">{{ managerRoom.name }}</h4>
              <span class="px-2 py-1 text-xs rounded-full"
                [class.bg-green-100]="managerRoom.state === 'playing'"
                [class.text-green-700]="managerRoom.state === 'playing'"
                [class.bg-yellow-100]="managerRoom.state === 'waiting'"
                [class.text-yellow-700]="managerRoom.state === 'waiting'"
                [class.bg-gray-100]="managerRoom.state !== 'playing' && managerRoom.state !== 'waiting'"
                [class.text-gray-700]="managerRoom.state !== 'playing' && managerRoom.state !== 'waiting'">
                {{ managerRoom.state }}
              </span>
            </div>
            <div class="text-sm text-gray-600">
              <div>Ronda: {{ managerRoom.currentRound }}/{{ managerRoom.config.maxRounds }}</div>
              <div>Cartas: {{ managerRoom.currentIndex + 1 }}/54</div>
              <div class="text-xs text-purple-600 mt-2">ID: {{ managerRoom.id }}</div>
            </div>
          </button>
        </div>
      </div>

      <div *ngIf="loadingRooms()" class="text-gray-500 mb-6">
        Cargando salas...
      </div>

      <div *ngIf="!loadingRooms() && managerRooms().length === 0" class="text-gray-500 mb-6">
        No tienes salas creadas a√∫n.
      </div>

      <!-- Bot√≥n crear sala -->
      <button 
        *ngIf="!showCreateForm()"
        (click)="toggleCreateForm()"
        class="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition">
        ‚ûï Crear Nueva Sala
      </button>

      <!-- Create room form -->
      <div *ngIf="showCreateForm()" class="mt-8">
        <form (ngSubmit)="createRoom()" class="space-y-6">
          <div>
            <label class="block text-left text-gray-700 font-semibold mb-2">Nombre de la Sala</label>
            <input 
              type="text"
              [(ngModel)]="roomName"
              name="roomName"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
              placeholder="Ej: Loter√≠a del Viernes">
          </div>

          <div>
            <label class="block text-left text-gray-700 font-semibold mb-2">N√∫mero de Rondas</label>
            <input 
              type="number"
              [(ngModel)]="maxRounds"
              name="maxRounds"
              min="1"
              max="20"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
          </div>

          <div>
            <label class="block text-left text-gray-700 font-semibold mb-2">Dificultad para Espectadores</label>
            <select 
              [(ngModel)]="difficulty"
              name="difficulty"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
              <option value="easy">F√°cil (√∫ltimas 5 cartas)</option>
              <option value="medium">Medio (√∫ltimas 2 cartas)</option>
              <option value="hard">Dif√≠cil (solo carta actual)</option>
            </select>
          </div>

          <div class="flex gap-4">
            <button 
              type="submit"
              class="flex-1 bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition">
              Crear Sala
            </button>
            <button 
              type="button"
              (click)="toggleCreateForm()"
              class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-400 transition">
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Room active -->
  <div *ngIf="room()" class="space-y-8">
    <!-- Room info -->
    <div class="bg-white rounded-2xl shadow-2xl p-8">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h2 class="text-3xl font-bold text-gray-800 mb-2">{{ room()!.name }}</h2>
          <div class="text-sm text-gray-600">ID: <span class="text-purple-700 font-semibold">{{ room()!.id }}</span></div>
        </div>
        <button
          (click)="openViewerView()"
          class="bg-white border-2 border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-50 transition">
          üëÅÔ∏è Vista Visitante
        </button>
      </div>

      <div class="grid grid-cols-3 gap-4 text-center mt-6">
        <div class="bg-purple-100 p-4 rounded-lg">
          <div class="text-2xl font-bold text-purple-600">{{ room()!.currentRound }}</div>
          <div class="text-sm text-gray-600">Ronda Actual</div>
        </div>
        <div class="bg-blue-100 p-4 rounded-lg">
          <div class="text-2xl font-bold text-blue-600">{{ room()!.currentIndex + 1 }}/54</div>
          <div class="text-sm text-gray-600">Cartas Cantadas</div>
        </div>
        <div class="bg-green-100 p-4 rounded-lg">
          <div class="text-2xl font-bold text-green-600">{{ room()!.state }}</div>
          <div class="text-sm text-gray-600">Estado</div>
        </div>
      </div>

      <!-- Room link -->
      <div class="mt-6 p-4 bg-gray-100 rounded-lg">
        <p class="text-sm text-gray-600 mb-2">Link de invitaci√≥n (jugadores):</p>
        <code class="text-purple-600 font-mono break-all">{{ room()!.inviteLink }}</code>
        <div class="mt-3 text-sm text-gray-600">
          Vista visitante: <code class="text-gray-800 font-mono break-all">{{ origin }}/viewer/{{ room()!.id }}</code>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Left: current card + suggestion + controls -->
      <div class="md:col-span-2 space-y-6">
        <div class="bg-white rounded-2xl shadow-2xl p-8 text-center">
          <h3 class="text-2xl font-bold text-gray-800 mb-6">Carta Actual</h3>
          <div class="flex justify-center">
            <app-card
              *ngIf="currentCard()"
              [card]="currentCard()!"
              [size]="'large'"
              [showVerso]="true"></app-card>
            <div *ngIf="!currentCard()" class="w-full flex justify-center">
              <div class="w-64 h-96 bg-gray-100 rounded-2xl border-4 border-gray-200 flex flex-col items-center justify-center">
                <div class="text-7xl text-gray-400">?</div>
                <div class="text-gray-500 font-semibold mt-4">ESPERANDO‚Ä¶</div>
              </div>
            </div>
          </div>

          <div class="mt-6 flex gap-4 justify-center flex-wrap">
            <button
              *ngIf="room()!.state === 'waiting'"
              (click)="startRound()"
              class="bg-purple-600 text-white px-8 py-4 rounded-lg font-semibold hover:bg-purple-700 transition text-xl">
              ‚ñ∂Ô∏è Iniciar Ronda
            </button>

            <button
              *ngIf="room()!.state === 'playing' || room()!.state === 'verifying'"
              (click)="nextCard()"
              class="bg-purple-600 text-white px-8 py-4 rounded-lg font-semibold hover:bg-purple-700 transition text-xl">
              ‚û°Ô∏è Siguiente Carta
            </button>

            <button
              *ngIf="room()!.state === 'playing' || room()!.state === 'verifying'"
              (click)="finishRound()"
              class="border-2 border-red-200 text-red-600 px-8 py-4 rounded-lg font-semibold hover:bg-red-50 transition text-xl">
              ‚èπÔ∏è Finalizar Ronda
            </button>
          </div>
        </div>

        <!-- Delete room button -->
        <div class="bg-white rounded-2xl shadow-2xl p-8">
          <button
            (click)="deleteRoom()"
            class="bg-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition">
            üóëÔ∏è Eliminar Sala
          </button>
        </div>
      </div>

      <!-- Right: next card + verification + players -->
      <div class="space-y-6">
        <div class="bg-gray-900 text-white p-6 rounded-2xl shadow-2xl">
          <p class="text-gray-300 text-xs uppercase font-bold mb-4">Pr√≥xima carta (solo t√∫ ves)</p>
          <div class="flex items-center gap-4">
            <div class="w-16 h-24 bg-gray-800 rounded-lg flex items-center justify-center text-3xl border border-gray-700">
              {{ nextCardPreview()?.emoji || '?' }}
            </div>
            <div>
              <p class="font-bold text-gray-100">{{ nextCardPreview()?.name || '???' }}</p>
              <p class="text-[10px] text-gray-400">LISTA PARA CANTAR</p>
            </div>
          </div>

          <div class="mt-4 text-center bg-gray-800/40 p-4 rounded-xl border border-gray-700">
            <p class="text-[10px] uppercase font-bold text-gray-300 mb-1 tracking-widest">Sugerencia para la pr√≥xima</p>
            <p class="text-gray-100 italic font-semibold">{{ nextVersoSuggestion() }}</p>
          </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-2xl border border-gray-100">
          <h4 class="font-bold mb-4 flex items-center gap-2 text-gray-700">‚úÖ Verificaci√≥n</h4>

          <div *ngIf="pendingWinners().length === 0" class="text-gray-500 text-sm">
            Sin solicitudes de verificaci√≥n.
          </div>

          <div *ngIf="pendingWinners().length > 0" class="space-y-3">
            <div
              *ngFor="let p of pendingWinners()"
              class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
              <div>
                <p class="font-bold text-sm">{{ p.displayName }}</p>
                <p class="text-xs text-gray-500">Grit√≥ ¬°Loter√≠a!</p>
              </div>
              <button
                (click)="reviewParticipant(p)"
                class="bg-purple-100 text-purple-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-purple-200">
                Revisar
              </button>
            </div>
          </div>

        </div>

        <div class="bg-white p-6 rounded-2xl shadow-2xl border border-gray-100">
          <h4 class="font-bold mb-4 text-gray-700">üë• Jugadores</h4>
          <div *ngIf="players().length === 0" class="text-gray-500 text-sm">Sin jugadores a√∫n.</div>
          <div *ngIf="players().length > 0" class="space-y-2">
            <div *ngFor="let p of players()" class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
              <div class="min-w-0">
                <div class="font-semibold text-gray-800 text-sm truncate">{{ p.displayName }}</div>
                <div class="text-xs text-gray-500">
                  marcador: {{ getMarkerEmoji(p.marker) }} ¬∑ tabla: {{ p.tablaCards?.length ? '‚úÖ' : '‚Äî' }}
                </div>
              </div>
              <button
                (click)="reviewParticipant(p)"
                class="text-purple-700 text-xs font-bold hover:underline">
                Ver tabla
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de revisi√≥n de tabla -->
<div
  *ngIf="isReviewModalOpen()"
  class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-start justify-center p-4 overflow-y-auto">
  <div class="bg-white w-full max-w-3xl rounded-2xl p-6 shadow-2xl flex flex-col max-h-[90vh]">
    <div class="flex justify-between items-start gap-4">
      <div>
        <h3 class="text-xl font-bold text-gray-900">
          Verificando a {{ reviewingParticipant()!.displayName }}
        </h3>
        <p class="text-sm text-gray-500">Revisa marcas y tabla del jugador</p>
      </div>
      <button (click)="clearReview()" class="text-gray-400 hover:text-gray-600">‚úï</button>
    </div>

    <div class="mt-6 flex-1 min-h-0 overflow-auto">
      <div *ngIf="!(reviewingParticipant()!.tablaCards?.length)" class="text-gray-600">
        Este jugador todav√≠a no tiene tabla registrada.
      </div>

      <div *ngIf="reviewingParticipant()!.tablaCards?.length" class="bg-gray-50 p-4 rounded-xl border border-gray-200 overflow-auto">
        <app-tabla
          [tablaCards]="reviewingParticipant()!.tablaCards || []"
          [marks]="reviewingParticipant()!.marks || []"
          [markerEmoji]="getMarkerEmoji(reviewingParticipant()!.marker)"
          [isInteractive]="false"
          [size]="'medium'">
        </app-tabla>
      </div>
    </div>

    <div class="mt-6 flex gap-3 justify-end">
      <button
        (click)="clearReview()"
        class="bg-gray-200 text-gray-800 px-5 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">
        Cerrar
      </button>
      <button
        (click)="approveWinner()"
        class="bg-green-600 text-white px-5 py-3 rounded-lg font-semibold hover:bg-green-700 transition">
        Dar el gane
      </button>
    </div>
  </div>
</div>
